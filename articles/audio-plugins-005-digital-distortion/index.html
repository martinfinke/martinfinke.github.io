<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <meta name=HandheldFriendly content=True> <meta name=MobileOptimized content=320> <meta name=viewport content="width=device-width"> <meta http-equiv=cleartype content=on> <meta property="fb:admins" content=100001493355877> <meta property="og:image" content="http://www.martin-finke.de/blog/img/making_audio_plugins_thumbnail.png"> <meta property="og:image:type" content="image/png"> <meta property="og:image:width" content=100> <meta property="og:image:height" content=100> <title>Making Audio Plugins Part 5: Digital Distortion - Martin Finke's Blog </title> <link rel=alternate href="/blog/feed.xml" type="application/rss+xml" title="Music &amp; Programming"> <link href="http://fonts.googleapis.com/css?family=Domine:700|Inconsolata:400,700" rel=stylesheet type="text/css"> <link rel=stylesheet href='/blog/css/4407aa6.css'> </head> <body class=article-detail> <header class=header> <div class=content-wrap> <h1>Making Audio Plugins Part 5: Digital Distortion</h1> <div class=taglinks><a href="/blog/tags/programming.html" class=taglink>Programming</a>, <a href="/blog/tags/dsp.html" class=taglink>DSP</a>, <a href="/blog/tags/making_audio_plugins.html" class=taglink>Making Audio Plugins</a> </div> </div> </header> <div id=content> <div class=content-wrap> <article class=article> <section class=content><p>It’s time to write our first plugin, a nasty digital distortion. <span class=more></span> To be more precise, the plugin will apply <a href="http://en.wikipedia.org/wiki/Clipping_%28audio%29">clipping</a> to the audio signal. Signal values above a certain threshold will be limited to it so that the threshold is never&nbsp;exceeded:</p> <p><a href="/blog/articles/audio-plugins-005-digital-distortion/threshold.jpg"><img src="/blog/articles/audio-plugins-005-digital-distortion/threshold.jpg" alt=Threshold></a></p> <p>Note that by “above” I mean “above a certain positive threshold <em>or below a certain negative threshold</em>“.</p> <p>Using the <code>duplicate</code> script <a href="/blog/articles/audio-plugins-002-setting-up-wdl-ol/#duplicate_script">introduced earlier</a>, we can clone any existing project to a new project with a new name. This means that we don’t have to make all the <a href="/blog/articles/audio-plugins-004-vst-and-au/#warnings">modifications</a> we did again for every new project.<br>Open a Terminal, go to your <em>IPlugExamples</em> folder and&nbsp;run:</p> <pre><code class="lang-bash">./duplicate.py MyFirstPlugin/ DigitalDistortion YourName
</code></pre> <p>If you haven’t followed the last post, you can download the files <a href="/blog/articles/audio-plugins-005-digital-distortion/finished-004.zip">here</a>. Make sure you don’t have any other project open in Xcode. From the newly created <em>DigitalDistortion</em> folder, open <em>DigitalDistortion.xcodeproj</em>. Verify that it builds the <em><span class=caps>APP</span></em> target without errors. Edit the Schemes <a href="/blog/articles/audio-plugins-004-vst-and-au/#edit_scheme">like I’ve shown before</a> to make sure Reaper runs for the <span class=caps>VST2</span> and <span class=caps>AU</span> targets. Don’t forget to change the <em>Arguments Passed On Launch</em> to point to the right <em>.<span class=caps>RPP</span></em> file.</p> <p>Now when you run Reaper, you’ll see that instead of loading <em>MyFirstPlugin</em>, it has magically loaded the <em>DigitalDistortion</em> plugin! This is because the Reaper project file is text-based and the <code>duplicate</code> script replaces all occurrences of “MyFirstPlugin” with&nbsp;“DigitalDistortion”.</p> <p>Let’s start with turning our <code>mGain</code> parameter into a <code>mThreshold</code> parameter. Go into <em>DigitalDistortion.h</em> and rename the <code>private</code> member&nbsp;variable:</p> <pre><code class="lang-cpp"><span class="keyword">private</span>:
  <span class="keyword">double</span> mThreshold;
</code></pre> <p>Now open <em>DigitalDistortion.cpp</em> and replace (Cmd+Alt+F) all occurrences of the word <em>Gain</em> with <em>Threshold</em>. You should be able to build without errors. <a name=parameter_initialization></a> Change the parameter initialization in the constructor to have <code>0.01</code> as the minimum and <code>100.0</code> as the default&nbsp;value:</p> <pre><code class="lang-cpp">GetParam(kThreshold)-&gt;InitDouble(<span class="string">"Threshold"</span>, <span class="number">100.0</span>, <span class="number">0.01</span>, <span class="number">100.0</span>, <span class="number">0.01</span>, <span class="string">"%"</span>);
</code></pre> <p>Let’s implement the <span class=caps>DSP</span>&nbsp;part:</p> <pre><code class="lang-cpp"><span class="keyword">void</span> DigitalDistortion::ProcessDoubleReplacing(
    <span class="keyword">double</span>** inputs,
    <span class="keyword">double</span>** outputs,
    <span class="keyword">int</span> nFrames)
{
  <span class="comment">// Mutex is already locked for us.</span>

  <span class="keyword">int</span> <span class="keyword">const</span> channelCount = <span class="number">2</span>;

  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; channelCount; i++) {
    <span class="keyword">double</span>* input = inputs[i];
    <span class="keyword">double</span>* output = outputs[i];

    <span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; nFrames; ++s, ++input, ++output) {
      <span class="keyword">if</span>(*input &gt;= <span class="number">0</span>) {
        <span class="comment">// Make sure positive values can't go above the threshold:</span>
        *output = fmin(*input, mThreshold);
      } <span class="keyword">else</span> {
        <span class="comment">// Make sure negative values can't go below the threshold:</span>
        *output = fmax(*input, -mThreshold);
      }
    }
  }
}
</code></pre> <p><a name=fmin_fmax_undefined></a> If you get an error that <code>fmax</code> and <code>fmin</code> are not defined, try changing the <code>fmin</code> call to just <code>min</code>, and <code>fmax</code> to <code>max</code>. If that doesn’t work, add this line to the top of <em>DigitalDistortion.cpp</em>:</p> <pre><code class="lang-cpp"><span class="preprocessor">#include &lt;math.h&gt;</span>
</code></pre> <p>If that still doesn’t solve the problem, try adding this line&nbsp;instead:</p> <pre><code class="lang-cpp"><span class="preprocessor">#include &lt;algorithm&gt;</span>
</code></pre> <p>And change the <code>fmin</code> to <code>std::min</code>, and <code>fmax</code> to <code>std::max</code>.</p> <p>Although the <code>channelCount</code> is still hardcoded, we have removed some duplication by using an outer <code>for</code> loop to iterate over all channels. This means that the plugin processes the samples for one audio channel at the time before processing the next channel.<br>The interesting part is the <code>if</code> statement: For positive values we take the input value or the threshold value, whichever is lower. For negative values we take <code>*input</code> or the negative threshold, whichever is <em>closer to zero</em>.<br>Run the plugin in Reaper and try it on the test tone. When the knob is all the way to the right, you’ll hear a clean tone. When you turn the knob counter-clockwise, it will start to sound more and more distorted.<br>You’ll also notice that the signal is getting quieter the more you distort it. That’s because the threshold goes towards zero and so we’re clipping the signal to very small values. To compensate for this, divide the signal value by the threshold&nbsp;value:</p> <pre><code class="lang-cpp"><span class="keyword">if</span>(*input &gt;= <span class="number">0</span>) {
  *output = fmin(*input, mThreshold);
} <span class="keyword">else</span> {
  *output = fmax(*input, -mThreshold);
}
*output /= mThreshold;
</code></pre> <p><a name=no_division_by_zero></a> Remember how we changed the parameter <a href="/blog/articles/audio-plugins-005-digital-distortion/#parameter_initialization">earlier</a> to have a minimum value of <code>0.01</code>? This ensures that we’re never dividing by zero, even if we turn the knob fully counter-clockwise.<br>If you run the plugin again, you’ll hear that the amplitude stays the same no matter how much you distort the signal. In fact, the signal appears to become <em>louder</em>! The clipping turns our sine wave input into something close to a square wave, which has a higher <a href="https://en.wikipedia.org/wiki/Root_mean_square#RMS_of_common_waveforms"><span class=caps>RMS</span></a> than a sine&nbsp;wave.</p> <p>For now, I’m intentionally keeping the <span class=caps>DSP</span> part as simple as I can. In my opinion, a good plugin isn’t just about processing a chunk of samples. It’s a combination&nbsp;of:</p> <ul> <li>Solid host integration (Presets,&nbsp;Compatibility)</li> <li>Good sound (<em>this</em> is pure&nbsp;<span class=caps>DSP</span>)</li> <li>Clear user&nbsp;interface</li> <li>Beautiful&nbsp;graphics</li> </ul> <p>So before we dive into more complex <span class=caps>DSP</span>, we will add <a href="/blog/articles/audio-plugins-006-presets/">presets</a> and a <a href="/blog/articles/audio-plugins-007-gui/">better <span class=caps>GUI</span></a> to our&nbsp;plugin.</p> </section> </article> <div id=donation_prompt>If you found this useful, please feel free to <form action="https://www.paypal.com/cgi-bin/webscr" method=post target=_top class=donation-form> <input type=hidden name=cmd value=_s-xclick> <input type=hidden name=hosted_button_id value=JQDU8W5PJBWL6> <input type=hidden name=ref value="/blog/articles/audio-plugins-005-digital-distortion/"> <input type=image src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border=0 name=submit alt="PayPal - The safer, easier way to pay online!"><img alt="" border=0 src="https://www.paypalobjects.com/de_DE/i/scr/pixel.gif" width=1 height=1> </form>! </div> <iframe src="//www.facebook.com/plugins/like.php?href=http%3A%2F%2Fwww.martin-finke.de%2Fblog%2F&amp;width=450&amp;height=21&amp;colorscheme=light&amp;layout=button_count&amp;action=like&amp;show_faces=false&amp;send=false" scrolling=no frameborder=0 style="border: none; overflow: hidden; width: 200px; height: 21px;" allowtransparency=true></iframe> <div class=comments> <div id=disqus_thread></div> <script type="text/javascript">var disqus_shortname="martinfinke";(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class=dsq-brlink>comments powered by <span class=logo-disqus>| Disqus</span></a> </div> </div> </div> <footer> <div class=content-wrap> <div class=nav><a href="/blog/">« Index</a></div> <section class=copy> <p>&copy; 2015 Martin Finke – <a href="/blog/impressum.html" class=impressum-link>Impressum</a></p> </section> </div> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> <script>window.jQuery||document.write('<script src="/blog/js/vendor/jquery-1.10.2.min.js"><\/script>');</script> <script type="text/javascript">$(document).ready(function(){$('a:link[href^=http]:not([href*="martin-finke.de"])').attr("target","_blank")});</script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-43375106-1"]);_gaq.push(["_trackPageview"]);(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src=("https:"==document.location.protocol?"https://":"http://")+"stats.g.doubleclick.net/dc.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();</script> </body> </html>