<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <meta name=HandheldFriendly content=True> <meta name=MobileOptimized content=320> <meta name=viewport content="width=device-width"> <meta http-equiv=cleartype content=on> <meta property="fb:admins" content=100001493355877> <meta property="og:image" content="http://www.martin-finke.de/img/making_audio_plugins_thumbnail.png"> <meta property="og:image:type" content="image/png"> <meta property="og:image:width" content=100> <meta property="og:image:height" content=100> <title>Making Audio Plugins Part 3: Examining the Code - Martin Finke's Blog </title> <link rel=alternate href="/feed.xml" type="application/rss+xml" title="Music &amp; Programming"> <link href="http://fonts.googleapis.com/css?family=Domine:700|Inconsolata:400,700" rel=stylesheet type="text/css"> <link rel=stylesheet href='/css/4407aa6.css'> </head> <body class=article-detail> <header class=header> <div class=content-wrap> <h1>Making Audio Plugins Part 3: Examining the Code</h1> <div class=taglinks><a href="/tags/programming.html" class=taglink>Programming</a>, <a href="/tags/making_audio_plugins.html" class=taglink>Making Audio Plugins</a> </div> </div> </header> <div id=content> <div class=content-wrap> <article class=article> <section class=content><p>Let’s have a closer look at the example project from last time. <span class=more></span> The most important files are <em>resource.h</em>, <em>MyFirstPlugin.h</em> and <em>MyFirstPlugin.cpp</em>. The plugin is a simple <em>gain</em> knob – it changes the volume of the audio passing&nbsp;through.</p> <h2 id=constants-flags-and-image-resources>Constants, Flags and Image&nbsp;Resources</h2> <p>Open <em>resource.h</em> from the project navigator. This file has constants for your plugin such as name, version, unique <span class=caps>ID</span> and image resources.<br>In lines 23–26 you can set the unique <em>Plugin <span class=caps>ID</span></em>:</p> <pre><code class="lang-c"><span class="comment">// 4 chars, single quotes. At least one capital letter</span>
<span class="preprocessor">#define PLUG_UNIQUE_ID 'Ipef'</span>
<span class="comment">// make sure this is not the same as BUNDLE_MFR</span>
<span class="preprocessor">#define PLUG_MFR_ID 'Acme'</span>
</code></pre> <p>The <span class=caps>ID</span> is important for cataloging plugins. You can register it <a href="http://service.steinberg.de/databases/plugin.nsf/plugIn?openForm">here</a>.<br>Line 56+ defines an <span class=caps>ID</span> and image path for the knob you see when you run the&nbsp;App:</p> <pre><code class="lang-c"><span class="comment">// Unique IDs for each image resource.</span>
<span class="preprocessor">#define KNOB_ID 101</span>

<span class="comment">// Image resource locations for this plug.</span>
<span class="preprocessor">#define KNOB_FN "resources/img/knob.png"</span>
</code></pre> <p>In the project navigator, open <em>Resources</em> → <em>img</em> → <em>knob.png</em>. It’s a sprite with 60 different knob positions – each of them is 48x48 Pixels. So when you run the app and turn the knob, it doesn’t <em>rotate</em> the image, but rather shows a certain 48x48 Pixel portion of it.<br>Why not just rotate a single image? Imagine you want your knob graphic to have a glossy look and a drop shadow. If you were to rotate the graphic, the gloss and shadow would also be rotated, which is not how it looks in the real&nbsp;world.</p> <p>Further down in <em>resource.h</em>, you can set the size of your plugin’s&nbsp;window:</p> <pre><code class="lang-c"><span class="preprocessor">#define GUI_WIDTH 300</span>
<span class="preprocessor">#define GUI_HEIGHT 300</span>
</code></pre> <p>Try changing the values and run the&nbsp;app.</p> <h2 id=the-plugin-class-interface>The Plugin Class&nbsp;Interface</h2> <p>Open <em>MyFirstPlugin.h</em>. It just contains the interface for your plugin class. The <code>public</code> part contains Constructor, Destructor and three member&nbsp;functions:</p> <ul> <li><code>Reset</code> is called when the <a href="http://www.dspguide.com/ch3/2.htm">sample rate</a> is&nbsp;changed.</li> <li><code>OnParamChange</code> is called when a plugin parameter changes, for example when you turn the&nbsp;knob.</li> <li><code>ProcessDoubleReplacing</code> is the core of your plugin. In this function you can process incoming&nbsp;audio.</li> </ul> <p>In the <code>private</code> section there’s just a <code>double</code> holding the current gain&nbsp;value.</p> <h2 id=the-implementation>The&nbsp;Implementation</h2> <p>Now for the interesting part! Open <em>MyFirstPlugin.cpp</em>. First of all we can see a nice trick for&nbsp;enums:</p> <pre><code class="lang-cpp"><span class="keyword">enum</span> EParams
{
  kGain = <span class="number">0</span>,
  kNumParams
};
</code></pre> <p>By setting the first option to <code>0</code> and <code>kNumParams</code> at the end, <code>kNumParams</code> becomes the number of options (1 in this case).<br>The following <code>enum</code> uses the constants described in <em>resource.h</em> and sets the position of the knob in the plugin’s&nbsp;window:</p> <pre><code class="lang-cpp"><span class="keyword">enum</span> ELayout
{
  kWidth = GUI_WIDTH,
  kHeight = GUI_HEIGHT,

  kGainX = <span class="number">100</span>,
  kGainY = <span class="number">100</span>,
  kKnobFrames = <span class="number">60</span>
};
</code></pre> <p>It also defines the number of frames in <em>knob.png</em> as 60.<br>Below that, the constructor implementation starts by setting up the plugins’ attributes:</p> <pre><code class="lang-cpp"><span class="comment">//arguments are: name, defaultVal, minVal, maxVal, step, label</span>
GetParam(kGain)-&gt;InitDouble(<span class="string">"Gain"</span>, <span class="number">50.</span>, <span class="number">0.</span>, <span class="number">100.0</span>, <span class="number">0.01</span>, <span class="string">"%"</span>);
</code></pre> <p>We can’t see the value and percent sign in the <span class=caps>GUI</span>, but the value can be between <code>0</code> and <code>100</code>, the default being <code>50</code>. You may have noticed, though, that the knob isn’t at <em>twelve o’clock</em>. This is because of the <code>SetShape(2.)</code> below. Set it to <code>1.0</code> and the knob will be as you expect. <code>SetShape</code> gives a knob a non-linear behaviour.<br>Next, the constructor creates a graphic context with the right size and creates the red&nbsp;background:</p> <pre><code class="lang-cpp">IGraphics* pGraphics = MakeGraphics(<span class="keyword">this</span>, kWidth, kHeight);
pGraphics-&gt;AttachPanelBackground(&amp;COLOR_RED);
</code></pre> <p>It then loads the <em>knob.png</em>, creates a new <code>IKnobMultiControl</code> with the image, and attaches it to the <span class=caps>GUI</span>. <code>IKnobMultiControl</code> is the C++ class for the <span class=caps>GUI</span> knob. Note how <code>kKnobFrames</code> is passed to indicate that the sprite contains 60&nbsp;frames.</p> <pre><code class="lang-cpp">IBitmap knob = pGraphics-&gt;LoadIBitmap(KNOB_ID, KNOB_FN, kKnobFrames);
pGraphics-&gt;AttachControl(<span class="keyword">new</span> IKnobMultiControl(<span class="keyword">this</span>, kGainX, kGainY, kGain, &amp;knob));
</code></pre> <p>Finally, the constructor attaches the graphics context, and it creates a default preset for the&nbsp;plugin:</p> <pre><code class="lang-cpp">MakeDefaultPreset((<span class="keyword">char</span> *) <span class="string">"-"</span>, kNumPrograms);
</code></pre> <p>Let’s look at <code>OnParamChange</code> (bottom of the file). The <code>IMutexLock</code> ensures <a href="http://en.wikipedia.org/wiki/Thread_safety">Thread Safety</a>, a concept we will dive into later. The rest is just a switch to do the right thing depending on which parameter was&nbsp;changed:</p> <pre><code class="lang-cpp"><span class="keyword">case</span> kGain:
    mGain = GetParam(kGain)-&gt;Value() / <span class="number">100.</span>;
    <span class="keyword">break</span>;
</code></pre> <p>Remember, the <code>kGain</code> parameter has values between 0 and 100. So after dividing by 100, we assign the result (between 0 and 1) to the <code>private</code> member <code>mGain</code>.</p> <p>So far, we have looked at how a <span class=caps>GUI</span> is created and how it can be linked to parameters like <code>mGain</code>. Let’s now look at how the plugin can process incoming audio. In our case, an audio stream is a sequence of <code>double</code> samples, each containing the amplitude at a given point in time.<br>The first parameter to <code>ProcessDoubleReplacing</code> is <code>double** inputs</code>. A sequence of <code>double</code> values can be passed using <code>double*</code>. The plugin processes two (stereo) or even more channels at once, so we have several sequences of <code>double</code> samples, that is, <code>double**</code>. The first two lines in the function make it more&nbsp;clear:</p> <pre><code class="lang-cpp"><span class="keyword">double</span>* in1 = inputs[<span class="number">0</span>];
<span class="keyword">double</span>* in2 = inputs[<span class="number">1</span>];
</code></pre> <p>Now, <code>in1</code> points to the first sequence of samples (left channel), <code>in2</code> to the samples for the right channel. After doing the same for the output buffer, we can iterate over the input and output buffers to process&nbsp;them:</p> <pre><code class="lang-cpp"><span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; nFrames; ++s, ++in1, ++in2, ++out1, ++out2)
{
  *out1 = *in1 * mGain;
  *out2 = *in2 * mGain;
}
</code></pre> <p>For every sample, we take the input value, multiply it by <code>mGain</code> and write it to the output buffer. <code>nFrames</code> tells us how many samples there are per channel so we know how long the buffers&nbsp;are.</p> <p>You may have noticed that when you run the app, you can hear yourself through your computer speakers. This is because by default, the standalone app takes your computer’s microphone as input. To change this (and some other audio preferences), go to the app’s&nbsp;preferences:</p> <p><a href="/articles/audio-plugins-003-examining-the-code/preferences-menu.jpg"><img src="/articles/audio-plugins-003-examining-the-code/preferences-menu.jpg" alt="App Preferences Menu"></a></p> <p><a href="/articles/audio-plugins-003-examining-the-code/preferences-window.jpg"><img src="/articles/audio-plugins-003-examining-the-code/preferences-window.jpg" alt="App Preferences Window"></a></p> <p>Set a breakpoint in the <code>Reset</code> function. Change the <em>Sampling Rate</em> on the right and click <em>Apply</em>. The debugger will break inside <code>Reset</code>. In the lower right where <code>lldb</code> is running, enter <code>print GetSampleRate()</code>.</p> <p><a href="/articles/audio-plugins-003-examining-the-code/debugger-output.jpg"><img src="/articles/audio-plugins-003-examining-the-code/debugger-output.jpg" alt="Debugger Output"></a></p> <p>Notice how you can call any function from the debugger and it will show the correct return value. Press <em>Stop</em> in the upper left corner when you’re ready to move on.<br>Now it’s time to actually create plugin versions of our app and load them into a host. We’ll cover that in the <a href="/articles/audio-plugins-004-vst-and-au/">next post</a>!</p> <h2 id=further-reading>Further&nbsp;Reading</h2> <p>To fill some gaps, read <a href="http://olilarkin.blogspot.de/2012/01/m4u-convention-iplug-workshop-slides.html">these slides</a> by the ingenius Mr. Oli Larkin. They explain a lot of things about <em><span class=caps>WDL</span>-<span class=caps>OL</span></em>.</p> </section> </article> <div id=donation_prompt>If you found this useful, please feel free to <form action="https://www.paypal.com/cgi-bin/webscr" method=post target=_top class=donation-form> <input type=hidden name=cmd value=_s-xclick> <input type=hidden name=hosted_button_id value=JQDU8W5PJBWL6> <input type=hidden name=ref value="/articles/audio-plugins-003-examining-the-code/"> <input type=image src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border=0 name=submit alt="PayPal - The safer, easier way to pay online!"><img alt="" border=0 src="https://www.paypalobjects.com/de_DE/i/scr/pixel.gif" width=1 height=1> </form>! </div> <iframe src="//www.facebook.com/plugins/like.php?href=http%3A%2F%2Fwww.martin-finke.de%2Fblog%2F&amp;width=450&amp;height=21&amp;colorscheme=light&amp;layout=button_count&amp;action=like&amp;show_faces=false&amp;send=false" scrolling=no frameborder=0 style="border: none; overflow: hidden; width: 200px; height: 21px;" allowtransparency=true></iframe> <div class=comments> <div id=disqus_thread></div> <script type="text/javascript">var disqus_shortname="martinfinke";(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class=dsq-brlink>comments powered by <span class=logo-disqus>| Disqus</span></a> </div> </div> </div> <footer> <div class=content-wrap> <div class=nav><a href="/">« Index</a></div> <section class=copy> <p>&copy; 2015 Martin Finke – <a href="/impressum.html" class=impressum-link>Impressum</a></p> </section> </div> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> <script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.10.2.min.js"><\/script>');</script> <script type="text/javascript">$(document).ready(function(){$('a:link[href^=http]:not([href*="martin-finke.de"])').attr("target","_blank")});</script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-43375106-1"]);_gaq.push(["_trackPageview"]);(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src=("https:"==document.location.protocol?"https://":"http://")+"stats.g.doubleclick.net/dc.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();</script> </body> </html>